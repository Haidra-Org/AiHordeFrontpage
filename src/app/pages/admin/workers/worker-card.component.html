<!-- Success Toast -->
@if (showSuccess()) {
  <div class="toast toast-success">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M5 13l4 4L19 7"
      />
    </svg>
    <span>{{ "admin.workers.success" | transloco }}</span>
  </div>
}

<!-- Dialog -->
@if (dialogOpen()) {
  <div class="worker-modal-overlay">
    <div class="modal-backdrop" (click)="closeDialog()"></div>
    <div class="worker-modal-panel worker-modal-panel-large">
      @switch (dialogType()) {
        @case ("models") {
          <h3 class="heading-card mb-4">
            {{
              "admin.workers.dialog.models_title"
                | transloco: { name: worker().name }
            }}
            <span class="text-secondary text-sm font-normal ml-2"
              >({{ getSortedModels().length }})</span
            >
          </h3>
          @if (getSortedModels().length > 0) {
            <div class="mb-4">
              <input
                type="text"
                [value]="modelSearch()"
                (input)="onModelSearchChange($event)"
                [placeholder]="'admin.workers.dialog.search_models' | transloco"
                class="form-input"
              />
            </div>
            <div class="worker-modal-scroll">
              @if (getFilteredModels().length > 0) {
                <ul class="worker-models-list">
                  @for (model of getFilteredModels(); track model) {
                    <li class="worker-models-list-item">{{ model }}</li>
                  }
                </ul>
              } @else {
                <p class="text-secondary text-sm">
                  {{ "admin.workers.dialog.no_models_match" | transloco }}
                </p>
              }
            </div>
          } @else {
            <p class="text-secondary text-sm">
              {{ "admin.common.none" | transloco }}
            </p>
          }
          <div class="flex justify-end mt-6">
            <button (click)="closeDialog()" class="worker-btn-models">
              {{ "admin.workers.dialog.close" | transloco }}
            </button>
          </div>
        }
        @case ("maintenance") {
          <h3 class="heading-card mb-4">
            @if (worker().maintenance_mode) {
              {{
                "admin.workers.dialog.unset_maintenance_title"
                  | transloco: { name: worker().name }
              }}
            } @else {
              {{
                "admin.workers.dialog.set_maintenance_title"
                  | transloco: { name: worker().name }
              }}
            }
          </h3>
          @if (!worker().maintenance_mode) {
            <div class="mb-4">
              <label class="text-sm text-secondary mb-2 block">
                {{ "admin.workers.dialog.maintenance_reason" | transloco }}
              </label>
              <textarea
                [value]="maintenanceReason()"
                (input)="onMaintenanceReasonChange($event)"
                rows="3"
                class="form-input"
              ></textarea>
            </div>
          }
          <div class="flex justify-end gap-3">
            <button (click)="closeDialog()" class="worker-btn">
              {{ "admin.workers.dialog.cancel" | transloco }}
            </button>
            <button
              (click)="confirmMaintenance()"
              [disabled]="isUpdating()"
              class="worker-btn-maintenance"
            >
              {{ "admin.workers.dialog.confirm" | transloco }}
            </button>
          </div>
        }
        @case ("pause") {
          <h3 class="heading-card mb-4">
            @if (worker().paused) {
              {{
                "admin.workers.dialog.unset_paused_title"
                  | transloco: { name: worker().name }
              }}
            } @else {
              {{
                "admin.workers.dialog.set_paused_title"
                  | transloco: { name: worker().name }
              }}
            }
          </h3>
          <div class="flex justify-end gap-3">
            <button (click)="closeDialog()" class="worker-btn">
              {{ "admin.workers.dialog.cancel" | transloco }}
            </button>
            <button
              (click)="confirmPause()"
              [disabled]="isUpdating()"
              class="worker-btn-pause"
            >
              {{ "admin.workers.dialog.confirm" | transloco }}
            </button>
          </div>
        }
        @case ("delete") {
          <h3 class="heading-card mb-4">
            {{
              "admin.workers.dialog.delete_title"
                | transloco: { name: worker().name }
            }}
          </h3>
          <div class="mb-4 space-y-3">
            <div
              class="p-3 rounded-lg bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700"
            >
              <p class="text-sm text-red-800 dark:text-red-200 font-medium">
                {{ "admin.workers.dialog.delete_warning_permanent" | transloco }}
              </p>
            </div>
            <div
              class="p-3 rounded-lg bg-amber-100 dark:bg-amber-900/30 border border-amber-300 dark:border-amber-700"
            >
              <p class="text-sm text-amber-800 dark:text-amber-200">
                {{
                  "admin.workers.dialog.delete_warning_offline_requirement"
                    | transloco
                }}
              </p>
            </div>
            @if (deleteError()) {
              <div
                class="p-3 rounded-lg bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700"
              >
                <p class="text-sm text-red-800 dark:text-red-200">
                  {{ "admin.workers.dialog.delete_error" | transloco }}
                </p>
              </div>
            }
          </div>
          <div class="flex justify-end gap-3">
            <button (click)="closeDialog()" class="worker-btn">
              {{ "admin.workers.dialog.cancel" | transloco }}
            </button>
            <button
              (click)="confirmDelete()"
              [disabled]="isUpdating()"
              class="btn-danger"
            >
              {{ "admin.workers.dialog.delete_confirm" | transloco }}
            </button>
          </div>
        }
      }
    </div>
  </div>
}

<!-- Card -->
<div [class]="getCardBackground()">
  <!-- Header -->
  <div class="p-4">
    <div class="flex items-start justify-between">
      <div class="flex items-center gap-3">
        <!-- Status Icon -->
        @if (!hasIssue()) {
          <div
            class="worker-status-icon worker-status-icon-success"
            [title]="'admin.workers.card.online' | transloco"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              />
            </svg>
          </div>
        } @else {
          <div
            class="worker-status-icon worker-status-icon-error"
            [title]="'admin.workers.card.issue' | transloco"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>
          </div>
        }

        <div class="min-w-0">
          <div class="flex items-center gap-2 mb-1">
            <h3 class="heading-item truncate" [title]="worker().name">
              {{ truncateName(worker().name) }}
            </h3>
            @switch (worker().type) {
              @case ("image") {
                <span class="badge-base badge-info">{{
                  "admin.workers.type.image" | transloco
                }}</span>
              }
              @case ("text") {
                <span class="badge-base badge-success">{{
                  "admin.workers.type.text" | transloco
                }}</span>
              }
              @case ("interrogation") {
                <span class="badge-base badge-purple">{{
                  "admin.workers.type.interrogation" | transloco
                }}</span>
              }
            }
          </div>
          <p class="text-xs text-secondary truncate">{{ worker().id }}</p>
        </div>
      </div>

      <!-- Status Badges -->
      <div class="flex items-center gap-1 shrink-0">
        @if (isLowSpeed()) {
          <div
            class="p-1"
            [title]="'admin.workers.card.low_speed_warning' | transloco"
          >
            <svg
              class="w-5 h-5 worker-indicator-yellow"
              style="transform: scaleX(-1)"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
          </div>
        }
        @if (isHighSpeed()) {
          <div
            class="p-1"
            [title]="'admin.workers.card.high_speed_warning' | transloco"
          >
            <svg
              class="w-5 h-5 worker-indicator-yellow"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
          </div>
        }
        @if (worker().paused) {
          <div class="p-1" [title]="'admin.workers.card.paused' | transloco">
            <svg
              class="w-5 h-5 worker-indicator-red"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"
              />
            </svg>
          </div>
        }
        @if (worker().maintenance_mode) {
          <div
            class="p-1"
            [title]="'admin.workers.card.maintenance' | transloco"
          >
            <svg
              class="w-5 h-5 worker-indicator-red"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </div>
        }
        @if (worker().flagged) {
          <div class="p-1" [title]="'admin.workers.card.flagged' | transloco">
            <svg
              class="w-5 h-5 worker-indicator-red"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"
              />
            </svg>
          </div>
        }
        @if (worker().trusted) {
          <div class="p-1" [title]="'admin.workers.card.trusted' | transloco">
            <svg
              class="w-5 h-5 worker-indicator-green"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
              />
            </svg>
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="p-4 text-sm worker-card-section">
    <!-- Basic Information -->
    <div class="space-y-1 mb-3">
      <div class="worker-card-row">
        <span class="worker-card-label"
          >{{ "admin.workers.card.owner" | transloco }}:</span
        >
        @if (getOwnerUserId() && isModerator()) {
          <a
            [routerLink]="['/admin/users', getOwnerUserId()]"
            class="worker-link truncate"
            [title]="worker().owner"
            >{{ getOwnerDisplayName() }}</a
          >
        } @else {
          <span class="worker-card-value" [title]="worker().owner ?? ''">{{
            getOwnerDisplayName()
          }}</span>
        }
      </div>
      @if (worker().team) {
        <div class="worker-card-row">
          <span class="worker-card-label"
            >{{ "admin.workers.card.team" | transloco }}:</span
          >
          <span
            class="worker-card-value truncate"
            [title]="worker().team?.name ?? worker().team?.id ?? ''"
            >{{ worker().team?.name ?? worker().team?.id ?? "" }}</span
          >
        </div>
      }
      <div class="flex flex-col">
        <span class="worker-card-label"
          >{{ "admin.workers.card.bridge_agent" | transloco }}:</span
        >
        @if (getParsedBridgeAgent(); as parsed) {
          <span class="worker-card-value" [title]="worker().bridge_agent"
            >{{ parsed.name }} v{{ parsed.version }}</span
          >
        } @else {
          <span class="worker-card-value" [title]="worker().bridge_agent">{{
            worker().bridge_agent
          }}</span>
        }
      </div>
      @if (getParsedBridgeAgent(); as parsed) {
        <div class="flex flex-col">
          <span class="worker-card-label"
            >{{ "admin.workers.card.software_contact" | transloco }}:</span
          >
          <span class="worker-card-value break-all">{{ parsed.contact }}</span>
        </div>
      }
      @if (worker().contact && isModerator()) {
        <div class="flex flex-col">
          <span class="worker-card-label"
            >{{ "admin.workers.card.contact" | transloco }}:</span
          >
          <span class="worker-card-value break-all">{{
            worker().contact
          }}</span>
        </div>
      }
      @if (worker().ipaddr && isModerator()) {
        <div class="worker-card-row">
          <span class="worker-card-label"
            >{{ "admin.workers.card.ipaddr" | transloco }}:</span
          >
          <span class="worker-card-value font-mono text-xs">{{
            worker().ipaddr
          }}</span>
        </div>
      }
    </div>

    <!-- Performance Metrics -->
    <div
      class="space-y-1 mb-3 pt-3 border-t border-gray-200 dark:border-gray-700"
    >
      <div class="worker-card-row">
        <span class="worker-card-label"
          >{{ "admin.workers.card.uptime" | transloco }}:</span
        >
        <span class="worker-card-value">{{
          formatUptime(worker().uptime)
        }}</span>
      </div>
      <div class="worker-card-row">
        <span class="worker-card-label"
          >{{ "admin.workers.card.speed" | transloco }}:</span
        >
        <span class="worker-card-value">{{ worker().performance }}</span>
      </div>
      <div class="worker-card-row">
        <span class="worker-card-label"
          >{{ "admin.workers.card.threads" | transloco }}:</span
        >
        <span class="worker-card-value">{{ worker().threads }}</span>
      </div>
      <div class="worker-card-row">
        <span class="worker-card-label"
          >{{ "admin.workers.card.requests_fulfilled" | transloco }}:</span
        >
        <span class="worker-card-value">{{
          worker().requests_fulfilled | formatNumber
        }}</span>
      </div>
      @if (
        worker().type === "image" &&
        worker().megapixelsteps_generated !== undefined
      ) {
        <div class="worker-card-row">
          <span class="worker-card-label"
            >{{ "admin.workers.card.mps_generated" | transloco }}:</span
          >
          <span class="worker-card-value">{{
            worker().megapixelsteps_generated ?? 0 | formatNumber
          }}</span>
        </div>
      }
      @if (
        worker().type === "text" && worker().tokens_generated !== undefined
      ) {
        <div class="worker-card-row">
          <span class="worker-card-label"
            >{{ "admin.workers.card.tokens_generated" | transloco }}:</span
          >
          <span class="worker-card-value">{{
            worker().tokens_generated ?? 0 | formatNumber
          }}</span>
        </div>
      }
    </div>

    <!-- Capabilities & Features -->
    <div class="space-y-1 pt-3 border-t border-gray-200 dark:border-gray-700">
      @if (worker().type !== "interrogation") {
        <div class="worker-card-row">
          <span class="worker-card-label"
            >{{ "admin.workers.card.models_loaded" | transloco }}:</span
          >
          <span class="worker-card-value">{{
            worker().models?.length ?? 0
          }}</span>
        </div>
      }
      @if (
        worker().type === "interrogation" && (worker().forms?.length ?? 0) > 0
      ) {
        <div class="worker-card-row">
          <span class="worker-card-label"
            >{{ "admin.workers.card.forms" | transloco }}:</span
          >
          <span class="worker-card-value">{{
            worker().forms?.join(", ") ?? ""
          }}</span>
        </div>
      }
      <div class="worker-card-row">
        <span class="worker-card-label"
          >{{ "admin.workers.card.nsfw" | transloco }}:</span
        >
        <span class="worker-card-value">{{
          worker().nsfw
            ? ("admin.common.yes" | transloco)
            : ("admin.common.no" | transloco)
        }}</span>
      </div>
    </div>

    <!-- Capabilities (Image workers) -->
    @if (worker().type === "image" && hasImageCapabilities()) {
      <div class="mt-3 pt-3 worker-card-section">
        <span class="worker-card-label text-xs block mb-2"
          >{{ "admin.workers.card.capabilities" | transloco }}:</span
        >
        <div class="flex flex-wrap gap-1">
          @if (worker().img2img) {
            <span class="worker-badge">img2img</span>
          }
          @if (worker().painting) {
            <span class="worker-badge">inpainting</span>
          }
          @if (worker()["post-processing"]) {
            <span class="worker-badge">post-processing</span>
          }
          @if (worker().lora) {
            <span class="worker-badge">LoRA</span>
          }
          @if (worker().controlnet) {
            <span class="worker-badge">ControlNet</span>
          }
          @if (worker().sdxl_controlnet) {
            <span class="worker-badge">SDXL ControlNet</span>
          }
        </div>
      </div>
    }

    <!-- Messages (Moderator only) -->
    @if ((worker().messages?.length ?? 0) > 0 && isModerator()) {
      <div class="mt-3 pt-3 worker-card-section">
        <span class="worker-card-label text-xs block mb-2"
          >{{ "admin.workers.card.messages" | transloco }} ({{
            worker().messages?.length ?? 0
          }}):</span
        >
        <div class="space-y-2 max-h-24 overflow-y-auto">
          @for (msg of worker().messages ?? []; track msg.message) {
            <div class="worker-message">
              <span class="worker-card-value">{{ msg.message }}</span>
              @if (msg.origin) {
                <span class="worker-card-label ml-1">({{ msg.origin }})</span>
              }
            </div>
          }
        </div>
      </div>
    }
  </div>

  <!-- Actions -->
  <div class="px-4 py-3 worker-card-section flex gap-2">
    <!-- Show Models -->
    <button
      (click)="openModelsDialog()"
      class="worker-btn-models text-sm"
      [title]="'admin.workers.action.show_models' | transloco"
    >
      {{ "admin.workers.button.models" | transloco }}
    </button>

    @if (canToggleMaintenance()) {
      <!-- Maintenance Toggle -->
      <button
        (click)="openMaintenanceDialog()"
        class="worker-btn-maintenance text-sm"
        [title]="'admin.workers.button.maintenance_tooltip' | transloco"
      >
        @if (worker().maintenance_mode) {
          {{ "admin.workers.button.disable_maintenance" | transloco }}
        } @else {
          {{ "admin.workers.button.maintenance" | transloco }}
        }
      </button>
    }

    @if (canTogglePause()) {
      <!-- Pause Toggle -->
      <button
        (click)="openPauseDialog()"
        class="worker-btn-pause text-sm"
        [title]="
          worker().paused
            ? ('admin.workers.action.unset_paused' | transloco)
            : ('admin.workers.action.set_paused' | transloco)
        "
      >
        @if (worker().paused) {
          {{ "admin.workers.button.unpause" | transloco }}
        } @else {
          {{ "admin.workers.button.pause" | transloco }}
        }
      </button>
    }

    @if (canDelete()) {
      <!-- Delete Worker -->
      <button
        (click)="openDeleteDialog()"
        class="btn-danger text-sm"
        [title]="'admin.workers.action.delete' | transloco"
      >
        {{ "admin.workers.button.delete" | transloco }}
      </button>
    }
  </div>
</div>
