<section class="section-primary">
  <div class="container-page-header">
    <div class="place-center">
      <h1 class="heading-hero">
        @if (auth.isLoggedIn()) {
          {{
            "profile.welcome"
              | transloco: { username: auth.currentUser()!.username }
          }}
        } @else {
          {{ "profile.login_title" | transloco }}
        }
      </h1>
    </div>
  </div>
</section>

<section class="section-secondary">
  <div class="container-spaced">
    <div class="grid-items">
      <div class="text-secondary sm:text-lg">
        @if (!auth.isLoggedIn()) {
          <!-- Login Form -->
          <div class="container-centered-md">
            <div class="card card-bg-primary">
              <h2 class="heading-card">
                {{ "profile.login_title" | transloco }}
              </h2>
              <p class="text-intro">
                {{ "profile.login_description" | transloco }}
              </p>
              <p class="text-intro text-secondary">
                {{ "profile.no_auth_warning" | transloco }}
              </p>

              <form [formGroup]="form" (ngSubmit)="login()">
                <div>
                  <label for="api_key" class="form-label">{{
                    "profile.api_key" | transloco
                  }}</label>
                  <input
                    formControlName="apiKey"
                    type="password"
                    id="api_key"
                    class="form-input"
                    required
                    [placeholder]="'profile.api_key_placeholder' | transloco"
                  />
                </div>
                @if (loginError()) {
                  <p class="text-error">
                    <small>{{ "invalid_api_key" | transloco }}</small>
                  </p>
                }

                <div>
                  <app-toggle-checkbox
                    [description]="'profile.remember_api_key' | transloco"
                    formControlName="remember"
                  />
                </div>

                <button
                  [disabled]="!form.valid || auth.isLoading()"
                  [class.btn-disabled]="!form.valid || auth.isLoading()"
                  [class.btn-primary]="form.valid && !auth.isLoading()"
                  type="submit"
                >
                  @if (auth.isLoading()) {
                    {{ "profile.logging_in" | transloco }}
                  } @else {
                    {{ "profile.login_button" | transloco }}
                  }
                </button>
              </form>

              <p class="text-secondary">
                {{ "profile.no_account" | transloco }}
                <a
                  href="https://aihorde.net/register"
                  class="link"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  {{ "register_account" | transloco }}
                </a>
              </p>
            </div>
          </div>
        } @else {
          <!-- User Profile -->
          <div class="container-page-content">
            <!-- Tab Navigation -->
            <div class="details-tabs">
              <button
                (click)="setActiveTab('profile')"
                class="details-tab"
                [class.details-tab-active]="activeTab() === 'profile'"
              >
                {{ "profile.tabs.profile" | transloco }}
              </button>
              <button
                (click)="setActiveTab('records')"
                class="details-tab"
                [class.details-tab-active]="activeTab() === 'records'"
              >
                {{ "profile.tabs.detailed_records" | transloco }}
              </button>
              <button
                (click)="setActiveTab('workers')"
                class="details-tab"
                [class.details-tab-active]="activeTab() === 'workers'"
              >
                {{ "profile.tabs.your_workers" | transloco }}
                @if (
                  auth.currentUser()!.worker_ids &&
                  auth.currentUser()!.worker_ids!.length > 0
                ) {
                  <span class="text-secondary text-sm"
                    >({{ auth.currentUser()!.worker_ids!.length }})</span
                  >
                }
              </button>
              <button
                (click)="setActiveTab('styles')"
                class="details-tab"
                [class.details-tab-active]="activeTab() === 'styles'"
              >
                {{ "profile.tabs.styles" | transloco }}
              </button>
              <button
                (click)="setActiveTab('shared-keys')"
                class="details-tab"
                [class.details-tab-active]="activeTab() === 'shared-keys'"
              >
                {{ "profile.tabs.shared_keys" | transloco }}
              </button>
            </div>

            <!-- Profile Card -->
            @if (activeTab() === "profile") {
              <div class="card card-bg-primary card-full">
                <div class="profile-header section-divider-bottom">
                  <div class="avatar-circle avatar-lg avatar-gradient">
                    <span class="avatar-text">{{
                      auth.currentUser()!.username.charAt(0).toUpperCase()
                    }}</span>
                  </div>
                  <div class="profile-header-content">
                    <h2 class="heading-subsection">
                      {{ auth.currentUser()!.username }}
                    </h2>
                    <p class="text-secondary text-sm">
                      ID: {{ auth.currentUser()!.id }}
                    </p>
                    @if (auth.currentUser()!.account_age) {
                      <p class="text-secondary text-sm">
                        {{
                          "profile.account_age"
                            | transloco
                              : {
                                  age: formatAccountAge(
                                    auth.currentUser()!.account_age!
                                  ),
                                }
                        }}
                      </p>
                    }
                  </div>
                </div>

                <!-- Badges -->
                <div class="badge-container">
                  @if (auth.currentUser()!.trusted) {
                    <span
                      class="badge-base badge-success"
                      [attr.title]="'admin.users.desc.trusted' | transloco"
                      >{{ "profile.badge.trusted" | transloco }}</span
                    >
                  }
                  @if (auth.currentUser()!.moderator) {
                    <span
                      class="badge-base badge-purple"
                      [attr.title]="'admin.users.desc.moderator' | transloco"
                      >{{ "profile.badge.moderator" | transloco }}</span
                    >
                  }
                  @if (auth.currentUser()!.education) {
                    <span
                      class="badge-base badge-info"
                      [attr.title]="'admin.users.desc.education' | transloco"
                      >{{ "profile.badge.education" | transloco }}</span
                    >
                  }
                  @if (auth.currentUser()!.service) {
                    <span
                      class="badge-base badge-warning"
                      [attr.title]="'admin.users.desc.service' | transloco"
                      >{{ "profile.badge.service" | transloco }}</span
                    >
                  }
                  @if (auth.currentUser()!.customizer) {
                    <span
                      class="badge-base badge-pink"
                      [attr.title]="'admin.users.desc.customizer' | transloco"
                      >{{ "profile.badge.customizer" | transloco }}</span
                    >
                  }
                  @if (auth.currentUser()!.special) {
                    <span
                      class="badge-base badge-secondary"
                      [attr.title]="'admin.users.desc.special' | transloco"
                      >{{ "profile.badge.special" | transloco }}</span
                    >
                  }
                  @if (auth.currentUser()!.pseudonymous) {
                    <span class="badge-base badge-secondary">{{
                      "profile.badge.anonymous" | transloco
                    }}</span>
                  }
                  @if (auth.currentUser()!.filtered) {
                    <span
                      class="badge-base badge-warning"
                      [attr.title]="'admin.users.desc.filtered' | transloco"
                      >{{ "profile.badge.filtered" | transloco }}</span
                    >
                  }
                  @if (auth.currentUser()!.flagged) {
                    <span
                      class="badge-base badge-danger"
                      [attr.title]="'admin.users.desc.flagged' | transloco"
                      >{{ "profile.badge.flagged" | transloco }}</span
                    >
                  }
                </div>

                <!-- Kudos Section -->
                <h3 class="heading-card">{{ "profile.kudos" | transloco }}</h3>
                <div class="highlight-box">
                  <span class="data-value-xl">{{
                    auth.currentUser()!.kudos | formatNumber
                  }}</span>
                  <span class="data-label-spaced">{{
                    "profile.kudos_balance" | transloco
                  }}</span>
                </div>

                @if (auth.currentUser()!.monthly_kudos?.amount) {
                  <p class="text-secondary text-sm text-center">
                    {{
                      "profile.monthly_kudos"
                        | transloco
                          : {
                              amount:
                                auth.currentUser()!.monthly_kudos!.amount!
                                | formatNumber,
                            }
                    }}
                  </p>
                }

                @if (
                  auth.currentUser()!.evaluating_kudos !== undefined &&
                  auth.currentUser()!.evaluating_kudos !== null &&
                  !auth.currentUser()!.trusted
                ) {
                  <p
                    class="text-secondary text-sm text-center"
                    [attr.title]="
                      'Evaluating Kudos from generations and uptime. When this reaches the threshold, you become trusted.'
                    "
                  >
                    <strong>Evaluating Kudos:</strong>
                    {{ auth.currentUser()!.evaluating_kudos! | formatNumber }}
                  </p>
                }

                @if (auth.currentUser()!.kudos < 100) {
                  <div
                    class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg"
                  >
                    <h4
                      class="text-sm font-semibold text-blue-900 dark:text-blue-100 mb-2"
                    >
                      {{ "profile.low_kudos_info_title" | transloco }}
                    </h4>
                    <p class="text-sm text-blue-800 dark:text-blue-200 mb-3">
                      {{ "profile.low_kudos_info_message" | transloco }}
                    </p>
                    <a
                      routerLink="/faq"
                      fragment="kudos"
                      class="text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline"
                    >
                      {{ "profile.low_kudos_info_link" | transloco }} â†’
                    </a>
                  </div>
                }

                @if (auth.currentUser()!.kudos_details) {
                  <div class="section-divider-top">
                    <h4 class="section-title-sm">
                      {{ "profile.kudos_breakdown" | transloco }}
                    </h4>
                    <app-kudos-breakdown-panel
                      [kudosDetails]="auth.currentUser()!.kudos_details!"
                      variant="profile"
                      [showZeroValues]="false"
                    />
                  </div>
                  <!-- Actions -->
                  <div class="section-divider-top">
                    <div class="action-row">
                      @if (auth.currentUser()!.moderator) {
                        <a routerLink="/admin" class="btn-primary">{{
                          "profile.admin_panel" | transloco
                        }}</a>
                      }
                      <a routerLink="/v2-transfer" class="btn-primary">{{
                        "profile.transfer_kudos" | transloco
                      }}</a>
                      <button (click)="logout()" class="btn-source-control">
                        {{ "profile.logout" | transloco }}
                      </button>
                    </div>
                  </div>
                }
              </div>
            }

            <!-- Detailed Records -->
            @if (
              activeTab() === "records" &&
              (auth.currentUser()!.records ||
                auth.currentUser()!.usage ||
                auth.currentUser()!.contributions)
            ) {
              <div class="card card-bg-primary card-full card-spaced">
                <h3 class="heading-card">
                  {{ "profile.detailed_records" | transloco }}
                </h3>
                <div class="records-section-wrapper">
                  <!-- Usage Records -->
                  @if (auth.currentUser()!.records!.usage) {
                    <div class="record-group">
                      <h4 class="section-title-sm">
                        {{ "profile.records.usage" | transloco }}
                      </h4>
                      <div class="data-grid-1-2">
                        @if (usageMegapixelsteps(); as ps) {
                          <div
                            class="data-item-box"
                            [attr.title]="
                              'Total megapixelsteps you have requested for image generation'
                            "
                          >
                            <span class="data-label">{{
                              "profile.records.megapixelsteps" | transloco
                            }}</span>
                            <span class="data-value">
                              {{ ps.primary.formatted }}
                              <span class="text-secondary">
                                (<app-unit-tooltip [unit]="ps" [swapDisplay]="true" />)
                              </span>
                            </span>
                          </div>
                        }
                        @if (usageTokens(); as tokens) {
                          <div
                            class="data-item-box"
                            [attr.title]="
                              'Total tokens you have requested for text generation'
                            "
                          >
                            <span class="data-label">{{
                              "profile.records.tokens" | transloco
                            }}</span>
                            <span class="data-value">
                              {{ tokens.primary.formatted }}
                              <span class="text-secondary">
                                (<app-unit-tooltip [unit]="tokens" [swapDisplay]="true" />)
                              </span>
                            </span>
                          </div>
                        }
                      </div>
                    </div>
                  }

                  <!-- Contribution Records -->
                  @if (auth.currentUser()!.records!.contribution) {
                    <div class="record-group">
                      <h4 class="section-title-sm">
                        {{ "profile.records.contribution" | transloco }}
                      </h4>
                      <div class="data-grid-1-2">
                        @if (contributionMegapixelsteps(); as ps) {
                          <div
                            class="data-item-box"
                            [attr.title]="
                              'Total megapixelsteps your workers have generated'
                            "
                          >
                            <span class="data-label">{{
                              "profile.records.megapixelsteps" | transloco
                            }}</span>
                            <span class="data-value">
                              {{ ps.primary.formatted }}
                              <span class="text-secondary">
                                (<app-unit-tooltip [unit]="ps" [swapDisplay]="true" />)
                              </span>
                            </span>
                          </div>
                        }
                        @if (contributionTokens(); as tokens) {
                          <div
                            class="data-item-box"
                            [attr.title]="
                              'Total tokens your workers have generated'
                            "
                          >
                            <span class="data-label">{{
                              "profile.records.tokens" | transloco
                            }}</span>
                            <span class="data-value">
                              {{ tokens.primary.formatted }}
                              <span class="text-secondary">
                                (<app-unit-tooltip [unit]="tokens" [swapDisplay]="true" />)
                              </span>
                            </span>
                          </div>
                        }
                      </div>
                    </div>
                  }

                  <!-- Request Records -->
                  @if (auth.currentUser()!.records!.request) {
                    <div class="record-group">
                      <h4 class="section-title-sm">
                        {{ "profile.records.requests" | transloco }}
                      </h4>
                      <div class="data-grid-1-2-3">
                        @if (auth.currentUser()!.records!.request!.image) {
                          <div
                            class="data-item-box data-item-centered"
                            [attr.title]="
                              'Total image generation requests you have made'
                            "
                          >
                            <span class="data-label">{{
                              "profile.records.image" | transloco
                            }}</span>
                            <span class="data-value">{{
                              auth.currentUser()!.records!.request!.image ?? 0
                                | formatNumber
                            }}</span>
                          </div>
                        }
                        @if (auth.currentUser()!.records!.request!.text) {
                          <div
                            class="data-item-box data-item-centered"
                            [attr.title]="
                              'Total text generation requests you have made'
                            "
                          >
                            <span class="data-label">{{
                              "profile.records.text" | transloco
                            }}</span>
                            <span class="data-value">{{
                              auth.currentUser()!.records!.request!.text ?? 0
                                | formatNumber
                            }}</span>
                          </div>
                        }
                        @if (
                          auth.currentUser()!.records!.request!.interrogation
                        ) {
                          <div
                            class="data-item-box data-item-centered"
                            [attr.title]="
                              'Total image interrogation requests you have made'
                            "
                          >
                            <span class="data-label">{{
                              "profile.records.interrogation" | transloco
                            }}</span>
                            <span class="data-value">{{
                              auth.currentUser()!.records!.request!
                                .interrogation ?? 0 | formatNumber
                            }}</span>
                          </div>
                        }
                      </div>
                    </div>
                  }

                  <!-- Fulfillment Records -->
                  @if (auth.currentUser()!.records!.fulfillment) {
                    <div class="record-group">
                      <h4 class="section-title-sm">
                        {{ "profile.records.fulfillments" | transloco }}
                      </h4>
                      <div class="data-grid-1-2-3">
                        @if (auth.currentUser()!.records!.fulfillment!.image) {
                          <div
                            class="data-item-box data-item-centered"
                            [attr.title]="
                              'Total image generations your workers have fulfilled'
                            "
                          >
                            <span class="data-label">{{
                              "profile.records.image" | transloco
                            }}</span>
                            <span class="data-value">{{
                              auth.currentUser()!.records!.fulfillment!.image ??
                                0 | formatNumber
                            }}</span>
                          </div>
                        }
                        @if (auth.currentUser()!.records!.fulfillment!.text) {
                          <div
                            class="data-item-box data-item-centered"
                            [attr.title]="
                              'Total text generations your workers have fulfilled'
                            "
                          >
                            <span class="data-label">{{
                              "profile.records.text" | transloco
                            }}</span>
                            <span class="data-value">{{
                              auth.currentUser()!.records!.fulfillment!.text ??
                                0 | formatNumber
                            }}</span>
                          </div>
                        }
                        @if (
                          auth.currentUser()!.records!.fulfillment!
                            .interrogation
                        ) {
                          <div
                            class="data-item-box data-item-centered"
                            [attr.title]="
                              'Total image interrogations your workers have fulfilled'
                            "
                          >
                            <span class="data-label">{{
                              "profile.records.interrogation" | transloco
                            }}</span>
                            <span class="data-value">{{
                              auth.currentUser()!.records!.fulfillment!
                                .interrogation ?? 0 | formatNumber
                            }}</span>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Workers Section -->
            @if (activeTab() === "workers") {
              <div class="card card-bg-primary card-full card-spaced">
                <h3 class="heading-card">
                  {{ "profile.your_workers" | transloco }}
                  @if (
                    auth.currentUser()!.worker_ids &&
                    auth.currentUser()!.worker_ids!.length > 0
                  ) {
                    <span class="text-secondary text-sm"
                      >({{ auth.currentUser()!.worker_ids!.length }})</span
                    >
                  }
                </h3>

                @if (
                  !auth.currentUser()!.worker_ids ||
                  auth.currentUser()!.worker_ids!.length === 0
                ) {
                  <p class="text-secondary text-center py-4">
                    {{ "profile.no_workers_registered" | transloco }}
                  </p>
                } @else {
                  <!-- Filter Controls -->
                  <div class="mb-4 flex flex-wrap gap-3 items-end">
                    <!-- Search Filter -->
                    <div class="flex-1 min-w-[200px]">
                      <label for="worker-search" class="form-label text-sm">{{
                        "profile.workers.search" | transloco
                      }}</label>
                      <input
                        type="text"
                        id="worker-search"
                        [value]="filterText()"
                        (input)="onFilterTextChange($event)"
                        [placeholder]="
                          'profile.workers.search_placeholder' | transloco
                        "
                        class="form-input"
                      />
                    </div>

                    <!-- Worker Type Filter -->
                    <div>
                      <label for="worker-type" class="form-label text-sm">{{
                        "profile.workers.type" | transloco
                      }}</label>
                      <select
                        id="worker-type"
                        [value]="filterWorkerType()"
                        (change)="
                          onFilterTypeChange($any($event.target).value)
                        "
                        class="form-input"
                      >
                        <option value="all">
                          {{ "profile.workers.type.all" | transloco }}
                        </option>
                        <option value="image">
                          {{ "profile.workers.type.image" | transloco }}
                        </option>
                        <option value="text">
                          {{ "profile.workers.type.text" | transloco }}
                        </option>
                        <option value="interrogation">
                          {{
                            "profile.workers.type.interrogation" | transloco
                          }}
                        </option>
                      </select>
                    </div>

                    <!-- Maintenance Status Filter -->
                    <div>
                      <label for="worker-status" class="form-label text-sm">{{
                        "profile.workers.status" | transloco
                      }}</label>
                      <select
                        id="worker-status"
                        [value]="filterMaintenance()"
                        (change)="
                          onFilterMaintenanceChange($any($event.target).value)
                        "
                        class="form-input"
                      >
                        <option value="all">
                          {{ "profile.workers.status.all" | transloco }}
                        </option>
                        <option value="active">
                          {{ "profile.workers.status.active" | transloco }}
                        </option>
                        <option value="maintenance">
                          {{
                            "profile.workers.status.maintenance" | transloco
                          }}
                        </option>
                        <option value="offline">
                          {{ "profile.workers.status.offline" | transloco }}
                        </option>
                      </select>
                    </div>
                  </div>

                  @if (loadingWorkers()) {
                    <p class="text-secondary text-sm mb-2">
                      {{ "profile.loading_workers" | transloco }}
                    </p>
                  }
                  
                  @if (!loadingWorkers() && filteredAndSortedWorkers().length === 0 && userWorkers().length > 0) {
                    <p class="text-secondary text-center py-4">
                      {{ "profile.no_workers_match_filters" | transloco }}
                    </p>
                  } @else {
                    <div class="worker-grid">
                      @for (
                        workerEntry of filteredAndSortedWorkers();
                        track workerEntry.id
                      ) {
                      @if (workerEntry.loading) {
                        <div class="skeleton-box" aria-busy="true">
                          <p class="data-value text-sm break-all">
                            {{ workerEntry.id }}
                          </p>
                          <div class="skeleton-bar skeleton-bar-sm"></div>
                          <div class="skeleton-bar skeleton-bar-lg"></div>
                          <p class="text-secondary text-sm">
                            {{ "profile.loading_workers" | transloco }}
                          </p>
                        </div>
                      } @else if (workerEntry.worker) {
                        <app-worker-card
                          [worker]="workerEntry.worker"
                          [isModerator]="auth.currentUser()?.moderator ?? false"
                          (workerUpdated)="onWorkerUpdated()"
                        />
                      } @else {
                        <div
                          class="skeleton-box skeleton-box-dashed"
                          role="status"
                        >
                          <p class="data-value text-sm break-all">
                            {{ workerEntry.id }}
                          </p>
                          <p class="text-secondary text-sm">
                            {{ "profile.no_workers_found" | transloco }}
                          </p>
                        </div>
                      }
                    }
                    </div>
                  }
                }
              </div>
            }

            <!-- Styles Section -->
            @if (activeTab() === "styles") {
              <div class="card card-bg-primary card-full card-spaced">
                <h3 class="heading-card">
                  {{ "profile.tabs.styles" | transloco }}
                  @if (
                    auth.currentUser()!.styles &&
                    auth.currentUser()!.styles!.length > 0
                  ) {
                    <span class="text-secondary text-sm"
                      >({{ auth.currentUser()!.styles!.length }})</span
                    >
                  }
                </h3>
                <app-profile-styles-list />
              </div>
            }

            <!-- Shared Keys Section -->
            @if (activeTab() === "shared-keys") {
              <div class="card card-bg-primary card-full card-spaced">
                <app-shared-key-list />
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>
</section>
